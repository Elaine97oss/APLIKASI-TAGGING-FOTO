<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Tagger Final v2 (Portrait Fix)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f4f6f9; padding: 20px; padding-bottom: 50px; }
        .main-container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .photo-card { 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 25px; 
            background: #fff; 
            position: relative; /* Agar tombol close bisa diposisikan absolute */
        }

        /* Tombol Hapus (X) */
        .btn-close-card {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: background 0.2s;
        }
        .btn-close-card:hover { background-color: #bb2d3b; }

        .preview-box {
            width: 100%;
            height: 250px;
            background-color: #333;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #999;
        }
        
        .preview-box img { 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; 
            display: block;
        }

        .result-preview {
            width: 100%;
            margin-top: 10px;
            border: 2px solid #198754;
            border-radius: 4px;
            display: none;
        }

        #map { height: 400px; width: 100%; border-radius: 8px; }

        /* Footer Disclaimer */
        .footer-disclaimer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
            color: #6c757d;
            text-align: center;
            font-style: italic;
        }
    </style>
</head>
<body>

<div class="main-container">
    <h2 class="text-center fw-bold mb-4">üì∏ Aplikasi Tagging Foto</h2>
    
    <div class="alert alert-primary py-2 small">
        <i class="bi bi-info-circle-fill"></i> Tips: Klik tombol <b>"Peta"</b> untuk mengisi lokasi otomatis.
    </div>

    <div class="mb-4">
        <label class="form-label fw-bold">1. Masukkan Foto (Maks 5)</label>
        <input type="file" id="imageInput" class="form-control" accept="image/*" multiple onchange="handleFiles()">
    </div>

    <div id="photoList"></div>

    <div class="d-grid gap-2 mt-4 pb-2">
        <button onclick="processAllImages()" class="btn btn-dark btn-lg py-3 btn-process">
            ‚ö° Proses Semua Foto
        </button>
    </div>

    <div class="text-center mt-3">
        <button onclick="window.location.reload()" class="btn btn-outline-danger btn-sm">
            üîÑ Mulai Ulang (Reset)
        </button>
    </div>

    <div class="footer-disclaimer">
        Disclaimer: Aplikasi ini dibuat untuk penyesuaian minor terhadap evident, tidak untuk tools utama. 
        Tools utama harus diambil dari device masing-masing sesuai dengan tanggal dan waktu kejadian. 
        Segala penyalahgunaan terhadap aplikasi ini di luar tanggung jawab pembuat.
    </div>
</div>

<div class="modal fade" id="mapModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pilih Titik Lokasi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="map"></div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Gunakan Lokasi Ini</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js"></script>

<script>
    let activePhotoId = null;
    let map, marker;
    let photosData = []; // Array objek foto

    // --- 1. INISIALISASI PETA ---
    function initMap() {
        map = L.map('map').setView([-2.5489, 118.0149], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        map.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lng]).addTo(map);

            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&accept-language=id`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (activePhotoId !== null) {
                    let parts = [];
                    const a = data.address;
                    if(a.road) parts.push(a.road);
                    if(a.village) parts.push(a.village);
                    if(a.suburb) parts.push(a.suburb);
                    if(a.city_district) parts.push(a.city_district);
                    if(a.city || a.regency) parts.push(a.city || a.regency);
                    if(a.state) parts.push(a.state);

                    const fullAddr = parts.join(", ") || data.display_name;
                    
                    document.getElementById(`addr-${activePhotoId}`).value = fullAddr;
                    document.getElementById(`coord-${activePhotoId}`).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
            } catch (err) {
                console.error(err);
                alert("Gagal memuat alamat. Cek koneksi internet.");
            }
        });
    }

    // --- 2. HANDLE FILE UPLOAD ---
    function handleFiles() {
        const input = document.getElementById('imageInput');
        const container = document.getElementById('photoList');
        
        container.innerHTML = ''; 
        photosData = [];

        if (input.files.length === 0) return;
        if (input.files.length > 5) { alert("Maksimal 5 foto."); return; }

        Array.from(input.files).forEach((file, index) => {
            photosData.push({ file: file, id: index, deleted: false });
            
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const defaultTime = now.toISOString().slice(0, 16);

            const html = `
                <div class="photo-card" id="card-${index}">
                    <button class="btn-close-card" onclick="removePhoto(${index})" title="Hapus Foto">√ó</button>
                    
                    <div class="row g-4">
                        <div class="col-md-5">
                            <label class="small fw-bold mb-1">Preview Asli:</label>
                            <div class="preview-box">
                                <img src="${URL.createObjectURL(file)}" alt="Preview Foto">
                            </div>
                            <img id="result-img-${index}" class="result-preview" alt="Hasil Edit">
                        </div>
                        
                        <div class="col-md-7">
                            <h5 class="fw-bold border-bottom pb-2">Foto #${index + 1}</h5>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="small text-muted">Waktu</label>
                                    <input type="datetime-local" id="date-${index}" class="form-control" value="${defaultTime}">
                                </div>
                                <div class="col-6">
                                     <label class="small text-muted">Koordinat</label>
                                     <div class="input-group">
                                        <input type="text" id="coord-${index}" class="form-control" placeholder="Lat, Long" readonly>
                                        <button class="btn btn-outline-primary" onclick="openMapModal(${index})">üó∫Ô∏è Peta</button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="small text-muted">Alamat / Lokasi</label>
                                <textarea id="addr-${index}" class="form-control" rows="3" placeholder="Pilih dari peta atau ketik manual..."></textarea>
                            </div>

                            <div class="d-grid">
                                <a id="download-${index}" class="btn btn-secondary disabled">
                                    ‚¨á Menunggu Proses...
                                </a>
                            </div>
                        </div>
                    </div>
                    <canvas id="canvas-${index}" style="display:none;"></canvas>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // Fungsi Hapus Foto
    function removePhoto(index) {
        if(photosData[index]) {
            photosData[index].deleted = true;
        }
        const card = document.getElementById(`card-${index}`);
        if(card) card.remove();
    }

    function openMapModal(id) {
        activePhotoId = id;
        const modal = new bootstrap.Modal(document.getElementById('mapModal'));
        modal.show();
        setTimeout(() => map.invalidateSize(), 500);
    }

    // --- 3. PROSES GAMBAR ---
    async function processAllImages() {
        const activePhotos = photosData.filter(p => !p.deleted);

        if (activePhotos.length === 0) { alert("Tidak ada foto untuk diproses!"); return; }

        const btn = document.querySelector('.btn-process');
        const oldText = btn.innerHTML;
        btn.innerHTML = '‚è≥ Sedang Memproses...';
        btn.disabled = true;

        for (let i = 0; i < photosData.length; i++) {
            if (photosData[i].deleted) continue;
            await renderImage(i);
        }

        btn.innerHTML = '‚úÖ Selesai!';
        setTimeout(() => { btn.innerHTML = oldText; btn.disabled = false; }, 2000);
    }

    function renderImage(index) {
        return new Promise((resolve) => {
            const canvas = document.getElementById(`canvas-${index}`);
            if (!canvas) { resolve(); return; }

            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            const dateVal = document.getElementById(`date-${index}`).value;
            const addrVal = document.getElementById(`addr-${index}`).value || "";
            const coordVal = document.getElementById(`coord-${index}`).value || "";

            moment.locale('id');
            const m = moment(dateVal);
            const timeStr = m.format('HH:mm');
            const dateStr = m.format('dddd, D MMMM YYYY');

            img.src = URL.createObjectURL(photosData[index].file);
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                
                ctx.drawImage(img, 0, 0);

                const W = canvas.width;
                const H = canvas.height;
                
                // --- PERUBAHAN DI SINI UNTUK FIX PORTRAIT ---
                // Menggunakan Math.min agar ukuran footer konsisten berdasarkan sisi terpendek
                const footerH = Math.min(W, H) * 0.25; 
                
                const footerY = H - footerH;
                const pad = W * 0.04; 

                // Background
                ctx.fillStyle = "rgba(20, 20, 20, 0.85)";
                ctx.fillRect(0, footerY, W, footerH);

                const fontTime = footerH * 0.45; 
                const fontText = footerH * 0.13; 
                
                ctx.textBaseline = "top";
                
                // Jam
                ctx.font = `bold ${fontTime}px Arial`;
                ctx.fillStyle = "white";
                const timeY = footerY + (footerH - fontTime)/2; 
                ctx.fillText(timeStr, pad, timeY);
                
                const timeWidth = ctx.measureText(timeStr).width;

                // Garis Kuning
                const lineX = pad + timeWidth + (pad * 0.5);
                ctx.fillStyle = "#FFC107";
                ctx.fillRect(lineX, timeY + (fontTime*0.1), W*0.005, fontTime*0.8);

                // Info Kanan
                const textX = lineX + (pad * 0.5); 
                const maxTextW = W - textX - pad;  
                
                // Koordinat
                ctx.font = `${fontText}px Arial`;
                const coordY = (H - (pad * 0.8)) - fontText;
                
                // Alamat
                ctx.fillStyle = "white"; 
                ctx.font = `bold ${fontText}px Arial`;
                const lines = wrapText(ctx, addrVal, maxTextW);
                const lineHeight = fontText * 1.4;
                const addrBlockHeight = lines.length * lineHeight;
                
                let cursorY = coordY - addrBlockHeight - (fontText * 0.5);
                
                const dateY = cursorY - lineHeight;

                // Render Teks
                // Tanggal
                ctx.font = `${fontText}px Arial`;
                ctx.fillText(dateStr, textX, dateY);

                // Alamat
                ctx.font = `bold ${fontText}px Arial`;
                lines.forEach((line, i) => {
                    ctx.fillText(line, textX, cursorY + (i * lineHeight));
                });

                // Koordinat
                ctx.font = `${fontText}px Arial`;
                ctx.fillText(coordVal, textX, coordY);

                // Output
                const dataURL = canvas.toDataURL("image/jpeg", 0.95);
                const dlBtn = document.getElementById(`download-${index}`);
                if(dlBtn) {
                    dlBtn.href = dataURL;
                    dlBtn.download = `Tag_${index+1}_${m.format('YYYYMMDD_HHmm')}.jpg`;
                    dlBtn.className = "btn btn-success w-100";
                    dlBtn.innerHTML = "‚úÖ Download Hasil";
                }

                const resImg = document.getElementById(`result-img-${index}`);
                if(resImg) {
                    resImg.src = dataURL;
                    resImg.style.display = "block";
                }

                resolve();
            };
        });
    }

    function wrapText(ctx, text, maxWidth) {
        const words = text.split(' ');
        let lines = [];
        let currentLine = words[0];

        for (let i = 1; i < words.length; i++) {
            let word = words[i];
            let width = ctx.measureText(currentLine + " " + word).width;
            if (width < maxWidth) {
                currentLine += " " + word;
            } else {
                lines.push(currentLine);
                currentLine = word;
            }
        }
        lines.push(currentLine);
        return lines;
    }

    window.onload = initMap;
</script>

</body>
</html>
